{% extends 'workshop_app/base.html' %}
{% block title %}Statistics{% endblock %}
{% block extra-custom-scripts %}
  <style>
   :root {
        --primary-color: #1173d4;
      }
      .navbar {
        background-color: #fff;
        border-bottom: 1px solid #dee2e6;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      }
      .navbar-brand .logo-icon {
        color: var(--primary-color);
      }
      .nav-link.active {
        color: var(--primary-color) !important;
      }
      .footer {
        background-color: #fff;
        border-top: 1px solid #dee2e6;
      }
      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }
      .btn-primary:hover {
        background-color: #0e63b7;
        border-color: #0d5aa8;
      }
      .filter-tag {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 1rem;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }
      .filter-tag .btn-close {
        font-size: 0.75rem;
        padding: 0.25rem;
      }
  </style>
{% endblock %}
{% block content %}
  <main class="container py-4 py-lg-5">
    <div class="mb-4">
      <h1 class="h2 fw-bold">Workshop Statistics</h1>
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-body p-4">
        <h2 class="h5 fw-semibold mb-3">Filter Options</h2>
        <form method="GET">
          <div class="row g-3">
            <div class="col-md">
              <label class="form-label" for="from-date">From Date</label>
              {{ form.from_date }}
            </div>
            <div class="col-md">
              <label class="form-label" for="to-date">To Date</label>
              {{ form.to_date }}
            </div>
            <div class="col-md">
              <label class="form-label" for="workshop">Workshop</label>
              {{ form.workshop_type }}
            </div>
            <div class="col-md">
              <label class="form-label" for="state">State</label>
              {{ form.state }}
            </div>
            <div class="col-md">
              <label class="form-label" for="sort-by">Sort By</label>
              {{ form.sort }}
            </div>
          </div>
          <div class="d-flex flex-wrap justify-content-end-md gap-2 mt-4">
            {% if request.user.is_authenticated %}
              <div class="col-md d-flex align-items-center me-auto">
                <label class="form-label mb-0 me-1" for="show_workshops">{{ form.show_workshops.help_text }}</label>
                {{ form.show_workshops }}
              </div>
            {% endif %}
            <div class="d-flex flex-wrap gap-2 mt-3 mt-md-0">
              <button class="btn btn-primary d-flex align-items-center" type="submit">
                <span class="material-symbols-outlined me-1">search</span>
                View
              </button>
              <button class="btn btn-secondary d-flex align-items-center"
                      type="submit"
                      name="download"
                      value="download">
                <span class="material-symbols-outlined me-1">download</span>
                Download
              </button>
              <a class="btn btn-outline-secondary d-flex align-items-center ms-auto-md"
                 href="{% url 'statistics_app:public' %}">
                <span class="material-symbols-outlined me-1 align-middle">close</span>
              Clear All</a>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="px-3" scope="col">Sr No.</th>
              <th class="px-3" scope="col">Coordinator Name</th>
              <th class="px-3" scope="col">Institute Name</th>
              <th class="px-3" scope="col">Instructor Name</th>
              <th class="px-3" scope="col">Workshop Name</th>
              <th class="px-3" scope="col">Workshop Date</th>
            </tr>
          </thead>
          <tbody>
            {% for workshop in objects %}
              <tr>
                <td class="px-3">{{ forloop.counter0|add:objects.start_index }}</td>
                <td class="px-3">{{ workshop.coordinator.get_full_name|capfirst }}</td>
                <td class="px-3">{{ workshop.coordinator.profile.institute|capfirst }}</td>
                <td class="px-3">{{ workshop.instructor.get_full_name|capfirst }}</td>
                <td class="px-3">{{ workshop.workshop_type.name }}</td>
                <td class="px-3">{{ workshop.date|date }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2 mt-3">
      <div class="me-auto d-flex align-items-center">{% include "statistics_app/paginator.html" %}</div>
      <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
        <button class="btn btn-secondary d-flex align-items-center"
                type="button"
                id="state_graph">
          <span class="material-symbols-outlined me-1">bar_chart</span>
          State Chart
        </button>
        <button class="btn btn-secondary d-flex align-items-center"
                type="button"
                id="type_graph">
          <span class="material-symbols-outlined me-1">pie_chart</span>
          Workshop Chart
        </button>
      </div>
    </div>
  </main>
  <!-- The Modal -->
  <div class="modal fade"
       id="workshopModal"
       tabindex="-1"
       aria-labelledby="workshopModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="workshopModalLabel">Workshops Statistics</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container-fluid">
            <div class="chart-container"
                 style="position: relative;
                        height:60vh;
                        width:100%">
              <canvas id="myChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
  var state_labels = {{ws_states|safe}};
  var state_data = {{ws_count|safe}};
  var type_labels = {{ws_type|safe}};
  var type_data = {{ws_type_count|safe}};
  var chart;

  $("#state_graph").on("click", function() {
      show_graph(state_labels, state_data, "State wise workshops");
  });
  $("#type_graph").on("click", function() {
      show_graph(type_labels, type_data, "Type wise workshops");
  });

  function show_graph(labels, data, graph_name) {
      var ctx = document.getElementById('myChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: labels,
              datasets: [{
                  data: data,
                  label: graph_name,
                  backgroundColor: 'rgba(255, 99, 132, 0.6)',
                  borderColor: 'rgb(255, 99, 132)',
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'top'
                  },
                  title: {
                      display: true,
                      text: graph_name
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
      var modal = new bootstrap.Modal(document.getElementById('workshopModal'));
      modal.show();
  }
  </script>
{% endblock %}
